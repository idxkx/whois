<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>域名批量查询</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #f9fafb; }
    header { background: #2563eb; color: white; padding: 16px 24px; }
    main { padding: 24px; }
    textarea { width: 100%; height: 200px; padding: 12px; border-radius: 6px; border: 1px solid #cbd5f5; }
    button { padding: 10px 20px; margin-top: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:disabled { background: #93c5fd; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #d1d5db; padding: 8px; text-align: left; }
    th { background: #e5e7eb; }
    .error { color: #dc2626; margin-top: 12px; display: inline-block; min-height: 24px; }
    .progress { margin-top: 8px; font-weight: 600; }
    .layout { display: flex; gap: 24px; margin-top: 24px; flex-wrap: wrap; }
    .panel { flex: 1; min-width: 320px; background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .panel h2 { margin-top: 0; }
    #available-list { max-height: 260px; overflow: auto; padding-left: 20px; }
  </style>
</head>
<body>
  <header>
    <h1>域名批量查询</h1>
  </header>
  <main>
    <p>粘贴候选名称（每行一个），点击“查询”即可查看实时状态。</p>
    <textarea id="domain-text" placeholder="例如：
alpha
beta
whois-ai"></textarea>
    <div>
      <button id="submit-btn">查询</button>
      <span class="error" id="error-msg"></span>
    </div>
    <div class="progress" id="progress-label"></div>
    <div class="layout">
      <section class="panel" style="flex:2;">
        <h2>查询进度</h2>
        <table id="result-table">
          <thead>
            <tr>
              <th>域名</th>
              <th>后缀</th>
              <th>状态</th>
              <th>查询时间</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
      <section class="panel" style="flex:1;">
        <h2>未注册列表</h2>
        <button id="download-btn" disabled>导出未注册</button>
        <ul id="available-list"></ul>
      </section>
    </div>
  </main>
  <script>
    const textarea = document.getElementById('domain-text');
    const button = document.getElementById('submit-btn');
    const tbody = document.querySelector('#result-table tbody');
    const errorMsg = document.getElementById('error-msg');
    const progressLabel = document.getElementById('progress-label');
    const downloadBtn = document.getElementById('download-btn');
    const availableList = document.getElementById('available-list');

    let controller;

    function resetUI() {
      errorMsg.textContent = '';
      progressLabel.textContent = '';
      tbody.innerHTML = '';
      availableList.innerHTML = '';
      downloadBtn.disabled = true;
      downloadBtn.dataset.items = '';
    }

    function updateProgress(completed, total) {
      if (!total) {
        progressLabel.textContent = '';
        return;
      }
      progressLabel.textContent = `进度：${completed} / ${total}`;
    }

    function renderAvailable(list) {
      availableList.innerHTML = '';
      list.forEach(domain => {
        const li = document.createElement('li');
        li.textContent = domain;
        availableList.appendChild(li);
      });
      if (list.length) {
        downloadBtn.disabled = false;
        downloadBtn.dataset.items = list.join('\n');
      } else {
        downloadBtn.disabled = true;
        downloadBtn.dataset.items = '';
      }
    }

    async function streamQuery() {
      resetUI();
      const payload = { text: textarea.value };
      if (!payload.text.trim()) {
        errorMsg.textContent = '请输入至少一行文本';
        return;
      }
      button.disabled = true;
      controller = new AbortController();
      try {
        const response = await fetch('/domain-query/batch-stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal,
        });

        if (!response.ok || !response.body) {
          const errBody = await response.json().catch(() => ({}));
          throw new Error(errBody.error || `HTTP ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let availableDomains = [];

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const parts = buffer.split('\n');
          buffer = parts.pop();
          for (const chunk of parts) {
            if (!chunk.trim()) continue;
            const payload = JSON.parse(chunk);
            if (payload.type === 'start') {
              updateProgress(0, payload.total);
            } else if (payload.type === 'result') {
              const tr = document.createElement('tr');
              tr.innerHTML = `<td>${payload.domain}</td>
                <td>${payload.domain_suffix}</td>
                <td>${payload.is_registered ? '已注册' : '未注册'}</td>
                <td>${payload.query_time || '-'}</td>`;
              tbody.appendChild(tr);
              updateProgress(payload.completed, payload.total);
              if (!payload.is_registered) {
                availableDomains.push(payload.domain);
                renderAvailable(availableDomains);
              }
            } else if (payload.type === 'complete') {
              updateProgress(payload.completed, payload.total);
              if (payload.unregistered && payload.unregistered.length) {
                availableDomains = payload.unregistered;
                renderAvailable(availableDomains);
              }
            } else if (payload.type === 'error') {
              throw new Error(payload.error || '未知错误');
            }
          }
        }
      } catch (err) {
        if (err.name !== 'AbortError') {
          errorMsg.textContent = err.message || '请求失败';
        }
      } finally {
        button.disabled = false;
        controller = null;
      }
    }

    button.addEventListener('click', () => {
      streamQuery();
    });

    downloadBtn.addEventListener('click', () => {
      const data = downloadBtn.dataset.items || '';
      if (!data) {
        return;
      }
      const blob = new Blob([data], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'available-domains.txt';
      a.click();
      URL.revokeObjectURL(url);
    });

    window.addEventListener('beforeunload', () => {
      if (controller) controller.abort();
    });
  </script>
</body>
</html>
